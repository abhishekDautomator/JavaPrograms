## âš¡ What Is a Circuit Breaker?

A **circuit breaker** monitors calls to external services. If failures exceed a threshold, it â€œopens the circuitâ€ â€” temporarily blocking further calls to prevent system overload.

### ğŸ” States of a Circuit Breaker:
| State       | Behavior |
|-------------|----------|
| **Closed**  | Calls flow normally |
| **Open**    | Calls are blocked immediately |
| **Half-Open** | A few test calls are allowed to check recovery |

---

## ğŸ§  Why Use It?

- âœ… Prevents retry storms and resource exhaustion
- âœ… Improves system stability
- âœ… Enables graceful degradation
- âœ… Works well with retries and fallbacks

---

## ğŸš€ Implementation with Spring Boot + Resilience4j

### ğŸ”¹ 1. Add Dependencies (`pom.xml`)
```xml
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot2</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

---

### ğŸ”¹ 2. Sample Service with Circuit Breaker

```java
@Service
public class ExternalService {

    @CircuitBreaker(name = "externalApi", fallbackMethod = "fallbackResponse")
    public String callExternalApi() {
        System.out.println("Calling external API...");
        throw new RuntimeException("API not available");
    }

    public String fallbackResponse(Throwable t) {
        return "External service is down. Please try later.";
    }
}
```

> ğŸ”¸ `@CircuitBreaker` monitors the method. If it fails repeatedly, it opens the circuit.
> ğŸ”¸ `fallbackMethod` is called when the circuit is open or the method throws an exception.

---

### ğŸ”¹ 3. Configuration (`application.yml`)
```yaml
resilience4j:
  circuitbreaker:
    instances:
      externalApi:
        registerHealthIndicator: true
        slidingWindowSize: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        permittedNumberOfCallsInHalfOpenState: 2
```

### ğŸ”¹ What This Means:
- After 5 calls, if â‰¥50% fail â†’ circuit opens
- Waits 10 seconds before trying again
- Allows 2 test calls in half-open state

---

### ğŸ”¹ 4. Controller to Trigger It

```java
@RestController
public class TestController {
    @Autowired private ExternalService externalService;

    @GetMapping("/test")
    public String testCircuitBreaker() {
        return externalService.callExternalApi();
    }
}
```

---

## ğŸ§ª Sample Flow

1. Call `/test` â†’ throws exception
2. After 3 failed calls â†’ circuit opens
3. Next calls â†’ immediately return fallback
4. After 10s â†’ circuit goes half-open
5. If test calls succeed â†’ circuit closes

---

## ğŸ§  Best Practices

| Practice | Why It Matters |
|---------|----------------|
| âœ… Combine with retry | Retry transient failures before breaking |
| âœ… Use fallback | Graceful degradation improves UX |
| âœ… Monitor metrics | Use Actuator + Prometheus/Grafana |
| âœ… Tune thresholds | Match SLA and traffic patterns |

---

## ğŸ” Bonus: Combine with Rate Limiter & Bulkhead

Resilience4j also supports:
- **Rate Limiting**: Prevent abuse
- **Bulkhead**: Isolate thread pools to avoid overload
- **Time Limiter**: Timeout slow calls